<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BkyhBot 控制台</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* 定义蓝白配色变量 */
        :root {
            --primary-blue: #4a90e2;    /* 主色调：天空蓝 */
            --light-bg: #f0f7ff;        /* 背景色：极淡蓝 */
            --white: #ffffff;
            --text-main: #333333;
            --border-color: #dbeafe;
        }

        body {
            font-family: 'Segoe UI', Microsoft YaHei, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* === 登录框样式 === */
        #login-panel {
            background: var(--white);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(74, 144, 226, 0.15); /* 柔和的蓝色阴影 */
            text-align: center;
            width: 320px;
            border: 1px solid var(--border-color);
        }

        .login-title {
            color: var(--primary-blue);
            margin-bottom: 20px;
            font-weight: 600;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #eef2f7;
            border-radius: 8px;
            box-sizing: border-box;
            outline: none;
            transition: 0.3s;
        }

        input:focus {
            border-color: var(--primary-blue);
        }

        .btn-primary {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn-primary:hover {
            background-color: #357abd;
        }

        /* === 主控制台样式 (默认隐藏) === */
        #dashboard-panel {
            display: none; /* 登录前隐藏 */
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.05);
            overflow: hidden;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #4a90e2, #63a4ff);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-area {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* 左侧侧边栏 */
        .sidebar {
            width: 280px;
            background: #fcfeff;
            border-right: 1px solid var(--border-color);
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-card {
            background: var(--white);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #edf2f9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }

        .info-label { font-size: 0.85rem; color: #8898aa; margin-bottom: 5px; }
        .info-value { font-size: 1.1rem; font-weight: bold; color: #2d3748; }

        /* 右侧日志区 */
        .log-section {
            flex: 1;
            padding: 25px;
            display: flex;
            flex-direction: column;
            background-color: #fafbfc;
        }

        .log-box {
            flex: 1;
            background: #1e293b; /* 深色背景看日志更清楚 */
            color: #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            overflow-y: auto; /* 允许滚动 */
            border: 1px solid #cbd5e0;
        }

        .log-line {
            margin-bottom: 4px;
            border-bottom: 1px solid #334155;
            padding-bottom: 2px;
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
    </style>
</head>
<body>

<div id="login-panel">
    <h2 class="login-title"><i class="bi bi-robot"></i> BkyhBot</h2>
    <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">请输入配置文件中的密钥</p>
    <input type="password" id="secret-input" placeholder="输入密钥...">
    <button class="btn-primary" onclick="login()">登 录</button>
</div>

<div id="dashboard-panel">
    <div class="header">
        <div style="font-size: 1.2rem; font-weight: bold;">
            <i class="bi bi-speedometer2"></i> 控制仪表盘
        </div>
        <button onclick="logout()" style="background: rgba(255,255,255,0.2); border:none; color:white; padding:8px 15px; border-radius:6px; cursor:pointer;">
            退出登录
        </button>
    </div>

    <div class="content-area">
        <div class="sidebar">
            <div class="info-card">
                <div class="info-label">机器人名称</div>
                <div class="info-value" id="bot-name">...</div>
            </div>
            <div class="info-card">
                <div class="info-label">机器人 QQ</div>
                <div class="info-value" id="bot-qq">...</div>
            </div>
            <div class="info-card">
                <div class="info-label">主人 QQ</div>
                <div class="info-value" id="master-qq">...</div>
            </div>
            <div class="info-card">
                <div class="info-label">系统状态</div>
                <div class="info-value" style="color: #28a745;">
                    <i class="bi bi-circle-fill" style="font-size: 0.6rem;"></i> 运行中
                </div>
            </div>
            <div class="info-card">
                <div class="info-label">操作系统</div>
                <div class="info-value" id="os-info" style="font-size: 0.9rem;">...</div>
            </div>
        </div>

        <div class="log-section">
            <h3 style="margin-top: 0; color: #4a5568;">实时日志监控</h3>
            <div class="log-box" id="log-container">
                <div>正在连接日志流...</div>
            </div>
        </div>
    </div>
</div>

<script>
    let token = localStorage.getItem('bot_token');
    let refreshTimer = null;

    // 如果本地存了密钥，尝试自动登录
    if(token) {
        showDashboard();
    }

    // 登录函数
    function login() {
        const input = document.getElementById('secret-input').value;
        if(!input) return alert("请输入密钥 (｡•ˇ‸ˇ•｡)");

        token = input;
        localStorage.setItem('bot_token', token); // 保存密钥
        showDashboard();
    }

    // 退出函数
    function logout() {
        localStorage.removeItem('bot_token');
        token = null;
        if(refreshTimer) clearInterval(refreshTimer);

        document.getElementById('login-panel').style.display = 'block';
        document.getElementById('dashboard-panel').style.display = 'none';
    }

    // 显示控制台并开始获取数据
    function showDashboard() {
        document.getElementById('login-panel').style.display = 'none';
        document.getElementById('dashboard-panel').style.display = 'flex';

        fetchInfo();
        // 每 2 秒刷新一次日志
        refreshTimer = setInterval(fetchLogs, 2000);
    }

    // 获取基本信息
    async function fetchInfo() {
        try {
            const res = await fetch('/api/info', { headers: { 'Authorization': token } });
            if(res.status === 401) return logout(); // 密钥不对，踢回登录页

            const data = await res.json();
            document.getElementById('bot-name').innerText = data.botName;
            document.getElementById('bot-qq').innerText = data.botQQ || "未连接";
            document.getElementById('master-qq').innerText = data.masterQQ;
            document.getElementById('os-info').innerText = data.os;
        } catch(e) {
            console.error("获取信息失败", e);
        }
    }

    // 获取日志
    async function fetchLogs() {
        try {
            const res = await fetch('/api/logs', { headers: { 'Authorization': token } });
            if(res.status === 401) return logout();

            const logs = await res.json();
            const container = document.getElementById('log-container');

            // 渲染日志
            container.innerHTML = logs.map(l => `<div class="log-line">${l}</div>`).join('');

            // 自动滚动到底部
            container.scrollTop = container.scrollHeight;
        } catch(e) {
            console.error("获取日志失败", e);
        }
    }
</script>
</body>
</html>