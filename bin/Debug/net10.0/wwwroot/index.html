<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BkyhBot 控制台</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root { --primary-blue: #4a90e2; --light-bg: #f0f7ff; --white: #ffffff; --text-main: #333333; --border-color: #dbeafe; }
        body { font-family: 'Segoe UI', Microsoft YaHei, sans-serif; background-color: var(--light-bg); color: var(--text-main); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }

        #login-panel { background: var(--white); padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(74, 144, 226, 0.15); text-align: center; width: 320px; border: 1px solid var(--border-color); }
        .login-title { color: var(--primary-blue); margin-bottom: 20px; font-weight: 600; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eef2f7; border-radius: 8px; box-sizing: border-box; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary-blue); }
        .btn-primary { background-color: var(--primary-blue); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 1rem; font-weight: 600; transition: 0.2s; }
        .btn-primary:hover { background-color: #357abd; }

        #dashboard-panel { display: none; width: 90%; max-width: 1200px; height: 90vh; background: var(--white); border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.05); overflow: hidden; flex-direction: column; }
        .header { background: linear-gradient(135deg, #4a90e2, #63a4ff); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .header-buttons { display: flex; gap: 10px; }
        .btn-logout { background: rgba(255,255,255,0.2); border:none; color:white; padding:8px 15px; border-radius:6px; cursor:pointer; }
        .btn-restart { background: rgba(231, 76, 60, 0.8); border:none; color:white; padding:8px 15px; border-radius:6px; cursor:pointer; transition: 0.2s; }
        .btn-restart:hover { background: rgba(231, 76, 60, 1); }
        .btn-restart:disabled { background: #ccc; cursor: not-allowed; }

        .content-area { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 280px; background: #fcfeff; border-right: 1px solid var(--border-color); padding: 25px; display: flex; flex-direction: column; gap: 15px; }
        .info-card { background: var(--white); padding: 15px; border-radius: 12px; border: 1px solid #edf2f9; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .info-label { font-size: 0.85rem; color: #8898aa; margin-bottom: 5px; }
        .info-value { font-size: 1.1rem; font-weight: bold; color: #2d3748; }

        .log-section { flex: 1; padding: 25px; display: flex; flex-direction: column; background-color: #fafbfc; }
        .log-box { flex: 1; background: #1e293b; color: #e2e8f0; border-radius: 12px; padding: 20px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9rem; line-height: 1.6; overflow-y: auto; border: 1px solid #cbd5e0; }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #334155; padding-bottom: 2px; word-break: break-all; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
    </style>
</head>
<body>

<div id="login-panel">
    <h2 class="login-title"><i class="bi bi-robot"></i> BkyhBot</h2>
    <input type="password" id="secret-input" placeholder="输入密钥...">
    <button class="btn-primary" onclick="login()">登 录</button>
</div>

<div id="dashboard-panel">
    <div class="header">
        <div style="font-size: 1.2rem; font-weight: bold;"><i class="bi bi-speedometer2"></i> 控制仪表盘</div>
        <div class="header-buttons">
            <button class="btn-restart" id="btn-restart" onclick="restartBot()">
                <i class="bi bi-arrow-clockwise"></i> 重启机器人
            </button>
            <button class="btn-logout" onclick="logout()">退出登录</button>
        </div>
    </div>
    <div class="content-area">
        <div class="sidebar">
            <div class="info-card"><div class="info-label">机器人名称</div><div class="info-value" id="bot-name">...</div></div>
            <div class="info-card"><div class="info-label">机器人 QQ</div><div class="info-value" id="bot-qq">...</div></div>
            <div class="info-card"><div class="info-label">主人 QQ</div><div class="info-value" id="master-qq">...</div></div>
            <div class="info-card"><div class="info-label">日志缓存</div><div class="info-value" id="log-count">0</div></div>
        </div>
        <div class="log-section">
            <h3 style="margin-top: 0; color: #4a5568;">实时日志监控</h3>
            <div class="log-box" id="log-container"><div>正在连接日志流...</div></div>
        </div>
    </div>
</div>

<script>
    let token = localStorage.getItem('bot_token');
    let refreshTimer = null;
    if(token) showDashboard();

    function login() {
        const input = document.getElementById('secret-input').value;
        if(!input) return alert("请输入密钥");
        token = input;
        localStorage.setItem('bot_token', token);
        showDashboard();
    }

    function logout() {
        localStorage.removeItem('bot_token');
        token = null;
        if(refreshTimer) clearInterval(refreshTimer);
        document.getElementById('login-panel').style.display = 'block';
        document.getElementById('dashboard-panel').style.display = 'none';
    }

    async function restartBot() {
        if(!confirm("确定要重启机器人吗？\n连接会暂时断开，请留意日志。")) return;

        const btn = document.getElementById('btn-restart');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 重启中...';

        try {
            const res = await fetch('/api/restart', { method: 'POST', headers: { 'Authorization': token } });
            if(res.status === 401) return logout();

            // 3秒后恢复按钮，因为重启通常很快，或者至少API调用很快返回
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 重启机器人';
            }, 3000);

        } catch(e) {
            alert("请求发送失败，可能是网络问题或服务已断开。");
            btn.disabled = false;
        }
    }

    function showDashboard() {
        document.getElementById('login-panel').style.display = 'none';
        document.getElementById('dashboard-panel').style.display = 'flex';
        fetchInfo();
        refreshTimer = setInterval(() => { fetchLogs(); fetchInfo(); }, 2000);
    }

    async function fetchInfo() {
        try {
            const res = await fetch('/api/info', { headers: { 'Authorization': token } });
            if(res.status === 401) return logout();
            const data = await res.json();
            document.getElementById('bot-name').innerText = data.botName;
            document.getElementById('bot-qq').innerText = data.botQQ;
            document.getElementById('master-qq').innerText = data.masterQQ;
            document.getElementById('log-count').innerText = data.logCount;
        } catch(e) {}
    }

    async function fetchLogs() {
        try {
            const res = await fetch('/api/logs', { headers: { 'Authorization': token } });
            if(res.status === 401) return logout();
            const logs = await res.json();
            const container = document.getElementById('log-container');

            // 智能滚动：只有当用户在底部时才自动滚动
            const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;

            container.innerHTML = logs.map(l => {
                let color = '#e2e8f0';
                if(l.includes("重启")) color = '#f1c40f'; // 黄色高亮重启日志
                if(l.includes("错误") || l.includes("失败")) color = '#e74c3c'; // 红色高亮错误
                if(l.includes("私聊")) color = '#2ecc71'; // 绿色高亮私聊
                return `<div class="log-line" style="color:${color}">${l}</div>`;
            }).join('');

            if(isAtBottom) container.scrollTop = container.scrollHeight;
        } catch(e) {}
    }
</script>
</body>
</html>